\cleardoublepage 

# (APPENDIX) 附录 {-}

# 概率编程 {#probabilistic-programming-language}

概率编程语言，图模型，贝叶斯推断，马尔科夫链蒙特卡罗，汉密尔顿蒙特卡罗，随机模拟，抽样分布，贝叶斯定理，先验后验

## Stan 简介 {#intro-stan}

何为 Stan [@Stan_2018_Bayesian] RStan [@R-rstan] 是 Stan 的 R 语言接口

设置参数

```{r stan-setup,message=FALSE,eval=FALSE}
Sys.setenv(USE_CXX14 = 1)
library("rstan") # observe startup messages
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores()/2)
```

准备数据

```{r load-data}
schools_dat <- list(J = 8, 
                    y = c(28,  8, -3,  7, -1,  1, 18, 12),
                    sigma = c(15, 10, 16, 11,  9, 11, 10, 18))
```

编译运行模型

```{r compile-run,message=FALSE,warning=FALSE}
system.time({
  fit <- stan(
    file = "code/stan/8schools.stan", data = schools_dat,
    iter = 1000, chains = 4
  )
}, gcFirst = TRUE)
```

输出结果

```{r stan-output}
print(fit,digits = 1)
```

参数的后验均值估计 (means) 蒙特卡罗标准误差 (se\_mean) 后验均值估计的标准偏差 (sd) 参数后验分布的五个分位点 $\hat{R}$ (the potential scale reduction derived from all chains after splitting each chain in half and treating the halves as chains) 和有效样本量 (n\_eff)


[结合实际数据详细解释这些个统计量的含义]{.todo}

诊断收敛性

```{r report}
check_hmc_diagnostics(fit)
```

```{r check-model,fig.cap="后验分布的散点矩阵图",out.width="35%",fig.show='hold',fig.asp=1,fig.width=4.5,fig.subcap=c("原始值","取对数")}
pairs(fit, pars = c("mu", "tau", "lp__"))
pairs(fit, pars = c("mu", "tau", "lp__"), log = TRUE)
```

[NUTS 采样器和 HMC 算法的参数设置]{.todo}

[诊断 Stan 的拟合结果]{.todo}

检测收敛性的一系列指标的图示 shinystan

[Stan 内置的优化器 optimizing]{.todo}




---

高斯过程，特别是空间广义线性混合效应模型

变分推断

市面上 WinBUGS/OpenBUGS/JAGS/INLA/MultiBUGS/BayesX/nimble 比较，一般的广义线性混合效应模型

空间广义线性混合效应模型 <https://github.com/XiangyunHuang/notesdown/issues/67>


## 空间高斯过程回归模型 {#spatial-gaussian-processes-regression-model}

空间高斯过程：首先是一个高斯过程，空间用以描述数据的背景，观测数据与空间位置有关系，可以的一维、二维、三维等，相应的高斯过程就是一维、二维、三维的。

空间线性混合效应模型：是一个线性模型，认为随机效应来自空间高斯过程，混合效应指的是固定效应和随机效应，其中固定效应可以直接观察到，而随机效应不能直接观察到。

空间高斯过程回归：认为数据由空间高斯过程产生

以 `geodata` 类的形式打包在 geoR 包里

elevation 数据集最初来自 John C. Davis （1973年）的书籍 [@Davis_2002_Statistics]，后来 J. J. Warnes 和 B. D. Ripley （1987年）以该数据集为例 指出空间高斯过程的协方差函数的似然估计中存在的问题 [@Warnes_1987_Problems]

地质统计数据是什么？地质统计包含哪些内容，研究对象是什么，研究哪些问题？广泛采用的克里金插值是什么？它与空间线性混合效应模型有什么关系？它与一般线性模型又有什么关系？

以海拔数据为例，预测海拔高度，线性预测与克里金插值的关系

```{r elevation-buble,echo=FALSE,fig.cap="空间数据可视化：以海拔数据为例",fig.subcap=c("气泡图","散点图"),small.mar=TRUE,out.width="35%",fig.show='hold',fig.asp=1,fig.width=4.5}
dat <- read.table(file = "data/NOTREDAM.TXT", header = T)
with(dat, {
  plot(c(0, 7), c(0, 7), type = "n", xlab = "East-West", ylab = "North-South")
  points(North.South ~ East.West,
    pch = 21,
    bg = gray(1, alpha = 0.5), cex = (Elevation - 600) / 90
  )
})
cols <- rev(gray.colors(4)) # terrain.colors(4)
elev2col <- function(x) {
  if (x <= 1) {
    col <- cols[1]
  } else if (x <= 2) {
    col <- cols[2]
  } else if (x <= 3) {
    col <- cols[3]
  } else if (x <= 4) 
    col <- cols[4]
}

dat <- transform(dat, elev2col = sapply((Elevation - 600) / 90, elev2col, USE.NAMES = TRUE))

with(dat, {
  plot(c(0, 7), c(0, 7), type = "n", xlab = "East-West", ylab = "North-South")
  for (i in seq(dim(dat)[1])) {
    points(dat[i, c(1, 2)], pch = 21, bg = dat[i, 4], cex = 2)
  }
})

with(dat, {
  plot(c(0, 7), c(0, 7), type = "n", xlab = "East-West", ylab = "North-South")
  for (i in seq(dim(dat)[1])) {
    points(dat[i, c(1, 2)], pch = 21, bg = dat[i, 4], cex = 2)
  }
})
```

plot 和 points 函数的 col 参数不支持向量化运算，即若传入一组向量，只会使用向量的第一个元素，所以绘制散点图\@ref(fig:elevation-buble)(b)时将海拔高度从低至高对应成由白至黑的四个灰度。比较来看，采用气泡图可能更合适些。当然也要注意气泡图采用的比例关系 [@Tanimura_2006_Proportional]，特别是在地图上绘制大量气泡时，要处理气泡之间可能存在的重叠和低对比度问题。


